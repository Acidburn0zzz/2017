<doctype html>
<html lang='en'>
<head>
	<meta charset='utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1' />
	<title>Ind.ie Labs - Blog - Gracefully running Node as an NSTask in Cocoa</title>
	<!--[if lte IE 8]>
    <script src='https://ind.ie/assets/js/html5shiv.js'></script>
  <![endif]-->
  <link rel='shortcut icon' href='/favicon.ico'>
  <link rel='apple-touch-icon' href='https://ind.ie/assets/images/ios-180.png'>
  <link rel='apple-touch-icon' sizes='76x76' href='https://ind.ie/assets/images/ios-76.png'>
  <link rel='apple-touch-icon' sizes='120x120' href='https://ind.ie/assets/images/ios-120.png'>
  <link rel='apple-touch-icon' sizes='152x152' href='https://ind.ie/assets/images/ios-152.png'>
  <link rel='apple-touch-icon' sizes='152x152' href='https://ind.ie/assets/images/ios-180.png'>
	<link rel='alternate' type='application/rss+xml' title='Ind.ie Labs Blog' href='https://ind.ie/labs/blog/rss/index.xml' />
	<link rel='stylesheet' href='https://ind.ie/assets/css/lab-styles.css'/>
	<link rel="stylesheet" href="../css/highlight/kimbie.dark.css">
	<link rel='stylesheet' href='../css/styles.css'/>
	<script src="../js/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
</head>
<body class='labs labs-blog'>
	<!-- @import '../../../../assets/includes/_nav.kit' -->
	<div class='main h-entry'>
        <!-- @import '../../../../includes/_archive-notice.kit' -->
		<h1 class='p-name long-title'>Gracefully running Node as an NSTask in Cocoa</h1>
		<p class='post-date dt-published' datetime='2015-04-12 14:30:00'>12th April, 2015 — <span class='p-author'>Aral Balkan</span></p>
		<div class='e-content'>

		<figure>
			<img src='images/activity-monitor.png' style='width:100%; margin:auto; display:block;' alt='Screenshot of Activity Viewer on OS X showing the sample app and its Node.js child process.'/>
			<figcaption>Graceful termination: when the parent process dies, the children should follow suit.</figcaption>
		</figure>

		<h2 id='update'>Update: 15th April, 2015</h2>

		<p>OK, this is weird: on further testing, it looks like I was confused about what was actually happening. It seems that (at least with the latest Xcode 6.3), the NSTask <em>is</em> killed properly when the Cocoa app terminates (even when stopped from within Xcode). However, the Node app itself spawns a child process for Pulse (the Go-based synchronisation engine), and it was <em>that</em> that wasn’t being cleaned up when the Cocoa app crashed or was stopped from within Xcode.</p>

		<p>It seems, however, that monitoring the parent process and running cleanup (including killing Pulse, by sending it a SIGTERM) is the only reliable way of killing that child process. So, while the below should not be necessary for NSTasks, it is still useful for running cleanup of child tasks launched from your child taks.</p>

		<p>Finally, I also added handlers in Node to call the clean up method for the various termination signals:</p>

		<pre>CoffeeScript: <code>process.on 'exit', (code) =>  
  @cleanUp()

process.on 'uncaughtException', (code) =>
  cleanUp()

process.on 'SIGINT', (code) =>
  @cleanUp()

process.on 'SIGTERM', (code) =>
  @cleanUp()
</code></pre>

		<h2>Graceful termination is hard to do</h2>

		<p>You’d think that tasks created by your Cocoa app would automatically be terminated by the system when your app crashes or is killed from Xcode.</p>

		<p><strike>You’d be wrong.</strike> <ins>(See <a href='#update'>update</a>.)</ins></p>

		<p>This tripped me up and apparently I’m not the only one (see <a href='http://stackoverflow.com/questions/1295996/ensure-a-subprocess-is-dead-in-cocoa'>this</a>, <a href='http://www.cocoabuilder.com/archive/cocoa/291918-how-to-assure-nstask-termination-when-parent-dies.html'>this</a>, and <a href='http://mac-os-x.10953.n7.nabble.com/Ensure-NSTask-terminates-when-parent-application-does-td31477.html'>this</a>, etc.)</p>

		<p>Instead of gracefully terminating, if an NSTask is running when your app crashes (or is stopped from Xcode), the task will dangle. This zombie task is a memory and CPU leak and might cause your app to misbehave or crash the next time it is run.</p>

		<h2>What doesn’t work</h2>

		<p>Before showing you what <em>does</em> work, here (in hopes of saving you time) are a couple of things I tried that don’t work:</p>

		<ul>
			<li>Killing the task in your App Delegate’s <code>applicationWillTerminate:</code> does not work as this is not called when the app is about to crash or when you stop it from Xcode.</li>
			<li>Listening for <a href='http://www.cocoawithlove.com/2010/05/handling-unhandled-exceptions-and.html'>unhandled exception calls</a> doesn’t work. In my Swift project I couldn’t even get the handler called. (See <a href='https://github.com/getsentry/raven-swift/blob/master/Raven/UncaughtExceptionHandler.m'>this</a> for how to use <code>NSSetUncaughtExceptionHandler</code> in Swift.)</li>
			<li>You can’t get a list of all running processes from Cocoa and then terminate the one you want (<code>NSRunningApplication</code> only returns the running Cocoa apps).</li>
		</ul>

		Basically, there doesn’t seem to be an easy way to manage child process cleanup from the Cocoa end of things.

		<h2>What does work</h2>

		<a href='downloads/GracefulNodeTask.zip' style='text-decoration:none;'><p style='width: 100%; background-color: #dddddd; padding: 10px;'><strong>Download source</strong> <small><em>(GracefulNodeTask.zip, ~12MB)</em></small></p></a>

		<p>The approach I finally took was based on the one used in the unfortunately-named <a href='https://github.com/mralexgray/Infanticide'>Infanticide</a> example by <a href='http://mrgray.com'>Alex Gray</a>:</p>

		<p>If we can’t monitor the child process and kill it, the child process can monitor the parent and kill itself when the parent dies. (This whole business is starting to sound rather more macarbre than I intended it to.)</p>

		<p>I created a simple standalone <a href='downloads/GracefulNodeTask.zip'>example app</a> that shows you how to run a Node.js app as an NSTask from within a sandboxed Cocoa app in a manner that gracefully handles the crashing or killing of the Cocoa app.</p>

		<p>Let’s take a look at the relevant bits of the code to understand how it works.</p>

		<h2>Cocoa</h2>

		<p>First off, in the <code>applicationDidFinishLaunching</code> handler, we set up the paths we need for configuring the task:</p>

		<pre>Swift <code>let mainBundle = NSBundle.mainBundle()
let pathToNodeApp = mainBundle.pathForResource("boot", ofType: "js", inDirectory: "js")!
let pathToNode = mainBundle.pathForResource("node", ofType: "")!
let pathToAppFolder = pathToNodeApp.stringByDeletingLastPathComponent
</code></pre>

		<p>Then, we make a note of our own process ID:</p>

		<pre>Swift: <code>let processIdentifier = NSProcessInfo.processInfo().processIdentifier</code></pre>

		<p>And, finally, we pass the process ID to the Node.js app as a commandline argument while creating the NSTask so that it knows which process to monitor:</p>

		<pre>Swift: <code>self.nodeTask = NSTask()
self.nodeTask!.currentDirectoryPath = pathToAppFolder
self.nodeTask!.launchPath = pathToNode
self.nodeTask!.arguments = [pathToNodeApp, "\(processIdentifier)"]
self.nodeTask!.standardOutput.fileHandleForReading.readInBackgroundAndNotify()
self.nodeTask!.launch()
</code></pre>

		<p>Those are the relevant bits on the Cocoa side of things.</p>

		<p>(The sample project does a little bit more, like piping standard output from Node to the Cocoa app, etc., so do <a href='downloads/GracefulNodeTask.zip'>download the source</a> and have a peek.)</p>

		<h2>Node</h2>

		<p>On the Node side of things, everything is inside a folder called <em>js</em>.</p>

		<p>When dragging Node.js source folders like this into your Cocoa projects, make sure that the <em>Copy items if needed</em> and <em>Create folder references</em> options are checked to ensure that the folder hierarchy of your Node app is maintained.</p>

		<p>Note also that I’ve dragged the Node.js binary into the project and that’s where we’re running it from.</p>

		<p>As using CoffeeScript for this example, I’ve added it to our <em>package.json</em>.</p>

		<p>We’re also using a module called <code>is-running</code> that checks whether a process is running <strong>in a manner that is compatible with Cocoa app sandboxing</strong>.</p>

		<pre>package.json <code>{
  …
  "dependencies": {
  "coffee-script": "1.9.1",
  "is-running": "1.0.5"
  }
}</code></pre>

		 The <em>boot.js</em> script is the entrypoint of our app. It registers CoffeeScript and includes <em>index.coffee</em>:</p>

		<pre>boot.js: <code>require('coffee-script/register');
require('./index.coffee');</code></pre>

		<p>In <em>index.coffee</em>, we first store the process ID passed from Cocoa:</p>

		<pre>CoffeeScript: <code>parentProcessID = parseInt(process.argv[2])
</code></pre>

		<p>Then., we start polling every second to see if the parent process is still alive. When the parent process dies, we gracefully terminate the Node process also:</p>

		<pre>CoffeeScript: <code>parentProcessHealthCheckerIntervalID = setInterval ->
  isProcessRunning parentProcessID, (err, parentIsRunning) ->
    if err
      throw err
    if !parentIsRunning
      console.log 'Parent process died. Exiting gracefully…'
      @cleanUp()
      exit 0
, 1000
</code></pre>

		<p>And that’s it.</p>

		<p>Within a second of the parent process crashing or being otherwise killed, the Node process will gracefully shut itself down.</p>

		<p>It took me a while to find this solution so I hope that it saves you some time in case you have the same problem.</p>

		</div>
		<div id="discourse-comments"></div>

<footer class="site-footer">
                <h2 class="site-name"><a href="https://ind.ie">ind.ie</a></h2>
                <small class="copyright"><abbr title="Copyright">©</abbr> <a href="/about/#trademarks">Article 12</a>. All content is <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International</a>, unless otherwise stated.</small>
                <div class="view-source-wrap">
                    <a class="view-source" href="https://source.ind.ie/project/ind-ie-site/tree/master">View source</a>
                </div>
            </footer>
	</div>
    <script type='text/javascript'>
      var discourseUrl = 'https://forum.ind.ie/',
          discourseEmbedUrl = 'https://ind.ie/labs/blog/gracefully-running-node-as-an-nstask-in-cocoa/';

      (function() {
        var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
          d.src = discourseUrl + 'javascripts/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
            })();
    </script>
</body>
</html>